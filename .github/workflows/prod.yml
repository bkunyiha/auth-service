name: Build, Test and Deploy to Prod

# Trigger the workflow when changes are pushed to the main branch
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

# During Build phase, force SQLx offline mode to prevent compile-time database connection errors
env:
  SQLX_OFFLINE: true

jobs:
  # Build and test job - runs tests and builds Docker images
  build:
    runs-on: ubuntu-latest

    # Expose Docker credential secrets as job env so they can be used in "if: env.*" expressions
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Early disk diagnostic
      run: |
        echo "Disk usage at job start"
        df -h /
        df -h /run || true
        df -i / || true
        echo "Top dirs in /run"
        sudo du -sh /run/* 2>/dev/null | sort -h | tail -n 20 || true

    - name: Aggressive but safe cleanup to free disk
      run: |
        # Remove stopped containers, dangling images, build cache and unused volumes
        docker container prune -f || true
        docker image prune -af || true
        docker volume prune -f || true
        docker builder prune -af || true
        # Free GitHub runner toolcache and tmp which can consume space
        sudo rm -rf /opt/hostedtoolcache/* || true
        sudo rm -rf /tmp/* || true

    - name: Disk diagnostic after cleanup
      run: |
        echo "Disk usage after cleanup"
        df -h /
        df -h /run || true
        docker system df || true

    - name: Start Postgres and Redis (after cleanup)
      run: |
        set -euo pipefail

        # Remove any previously-created containers with the same names (ignore errors)
        docker rm -f ci-postgres >/dev/null 2>&1 || true
        docker rm -f ci-redis >/dev/null 2>&1 || true

        # Start Postgres and Redis
        docker run --name ci-postgres -e POSTGRES_USER=postgres \
          -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
          -e POSTGRES_DB=postgres -p 5432:5432 -d postgres:15.2-alpine
        docker run --name ci-redis -p 6379:6379 -d redis:7.0-alpine

        # Wait for Postgres readiness (timeout after 30s)
        for i in $(seq 1 30); do
          if docker exec ci-postgres pg_isready -U postgres >/dev/null 2>&1; then
            echo "Postgres is ready"
            break
          fi
          echo "Waiting for postgres... ($i/30)"
          sleep 1
        done

        # Fail fast if Postgres did not become ready
        if ! docker exec ci-postgres pg_isready -U postgres >/dev/null 2>&1; then
          echo "Postgres did not become ready in time" >&2
          docker logs ci-postgres || true
          exit 1
        fi

        # Wait for Redis readiness (timeout after 30s)
        for i in $(seq 1 30); do
          if docker exec ci-redis redis-cli ping | grep -q PONG; then
            echo "Redis is ready"
            break
          fi
          echo "Waiting for redis... ($i/30)"
          sleep 1
        done

        # Fail fast if Redis did not become ready
        if ! docker exec ci-redis redis-cli ping | grep -q PONG; then
          echo "Redis did not become ready in time" >&2
          docker logs ci-redis || true
          exit 1
        fi

        echo "Postgres and Redis are ready"

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Cache cargo registry and build artifacts
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: cargo-cache-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-cache-${{ runner.os }}-

    - name: Run tests
      run: |
        # Ensure SQLX_OFFLINE remains set; tests should use the local test DB started above
        cargo test --workspace --verbose

    - name: Build release binary
      run: |
        cargo build --release --workspace

    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        push: false
        tags: |
          ghcr.io/${{ github.repository_owner }}/auth-service:latest
        context: .
        file: ./Dockerfile

    - name: Log in to Docker Hub (optional)
      if: env.DOCKER_USERNAME != '' && env.DOCKER_PASSWORD != ''
      uses: docker/login-action@v2
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ env.DOCKER_PASSWORD }}

    - name: Push Docker image to Docker Hub (optional)
      if: env.DOCKER_USERNAME != '' && env.DOCKER_PASSWORD != ''
      uses: docker/build-push-action@v4
      with:
        push: true
        tags: |
          ${{ env.DOCKER_USERNAME }}/auth-service:latest
        context: .
        file: ./Dockerfile

    - name: Final message
      run: echo "Build, test and image build completed successfully."