# Auth Service

A Rust-based authentication service with a companion app service, built using Axum, PostgreSQL, and Redis.

## Project Structure

- `auth-service/` - Main authentication service (port 3000)
- `app-service/` - Companion application service (port 8000)
- `nginx-conf/` - Nginx configuration
- `mount_dir/` - Docker volume mount points

## Prerequisites

- Rust (latest stable)
- Docker & Docker Compose
- PostgreSQL (for local development)
- Redis (for local development)

## Quick Start

### 1. Install Dependencies

```bash
cargo install cargo-watch
```

### 2. Build the Project

```bash
# Build both services
cargo build
```

### 3. Setup Database Migrations

Follow the [SQLx CLI documentation](https://github.com/launchbadge/sqlx/blob/main/sqlx-cli/README.md#enable-building-in-offline-mode-with-query) for offline mode setup.

### 4. Create Required Directories

```bash
mkdir -p mount_dir/postgres mount_dir/dhparam mount_dir/auth-service/html
```

## Running the Services

### Option 1: Docker Compose (Recommended)

```bash
# Start all services
docker compose up

# Visit the services
# App Service: http://localhost:8000
# Auth Service: http://localhost:3000
```

### Option 2: Manual Docker Setup

#### Start Database Services

```bash
# PostgreSQL
docker run --name db \
  -e POSTGRES_PASSWORD={YOUR_SECURE_PASSWORD} \
  --volume ./mount_dir/postgres:/var/lib/postgresql/data \
  -p 5432:5432 \
  -d postgres:15.2-alpine

# Redis
docker run --name redis-db \
  -p "6379:6379" \
  -d redis:7.0-alpine
```

#### Setup Database

```bash
cd auth-service
sqlx database create
cargo sqlx prepare
export SQLX_OFFLINE=true
```

#### Run Services

**App Service:**
```bash
cd app-service
cargo watch -q -c -w src/ -w assets/ -w templates/ -x run
# Visit: http://localhost:8000
```

**Auth Service:**
```bash
cd auth-service
cargo watch -q -c -w src/ -w assets/ -x run
# Visit: http://localhost:3000
```

### Option 3: Using Docker Script

```bash
./docker.sh
# Visit: http://localhost:8000 and http://localhost:3000
```

## Development

### Running Tests

Make sure the database is running for integration tests:

```bash
# Start services
docker compose up -d

# Run tests
cargo test
```

### Hot Reloading

Both services support hot reloading with `cargo watch`:

```bash
# App service with hot reload
cd app-service
cargo watch -q -c -w src/ -w assets/ -w templates/ -x run

# Auth service with hot reload
cd auth-service
cargo watch -q -c -w src/ -w assets/ -x run
```

## Environment Variables

Create a `.env` file with the following variables:

```env
JWT_SECRET=your_jwt_secret_here
APP_SERVICE_HOST=0.0.0.0:8000
POSTGRES_PASSWORD=your_secure_password
DATABASE_URL=postgres://postgres:${POSTGRES_PASSWORD}@localhost:5432
POSTMARK_AUTH_TOKEN=your_postmark_token
EMAIL_SERVICE_HOST=https://api.postmarkapp.com/email
EMAIL_FROM_USER=your_email@domain.com
EMAIL_TIMEOUT_MILLIS=10
SQLX_OFFLINE=true
RUST_LOG=DEBUG
```

## Services

### Auth Service (Port 3000)
- User authentication and authorization
- JWT token management
- Two-factor authentication
- Email verification
- Password hashing and validation

### App Service (Port 8000)
- Main application interface
- User dashboard
- Integration with auth service

## Docker Volumes

The following directories are used for Docker volume mounts:

- `mount_dir/postgres/` - PostgreSQL data persistence
- `mount_dir/dhparam/` - SSL DH parameters
- `mount_dir/auth-service/html/` - Web server files

## Troubleshooting

### Common Issues

1. **Docker Compose fails with mount errors**: Ensure all required directories exist (see Quick Start section)

2. **Database connection issues**: Verify PostgreSQL is running and credentials are correct

3. **SSL certificate errors**: This is expected on first run - certificates will be generated by certbot

### Logs

View service logs:

```bash
# All services
docker compose logs

# Specific service
docker compose logs auth-service
docker compose logs app-service
```